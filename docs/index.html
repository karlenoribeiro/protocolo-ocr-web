<!doctype html> <!-- Define o tipo de documento como HTML5 -->
<html lang="pt-br"> <!-- Início do documento HTML com idioma definido para português do Brasil -->
<head>
  <meta charset="utf-8"> <!-- Define o conjunto de caracteres como UTF-8, garantindo suporte a acentos -->
  <title>Extração de Protocolos (17 dígitos)</title> <!-- Título da aba do navegador -->
  <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Ajusta a página para ser responsiva em dispositivos móveis -->
  
  <style>
    /* ---------- VARIÁVEIS DE CORES ---------- */
    :root { --bg:#0f172a; --card:#111827; --text:#e5e7eb; --muted:#9ca3af; --accent:#22c55e; }

    /* ---------- ESTILIZAÇÃO GERAL ---------- */
    body { 
      margin:0; /* Remove margens padrão do navegador */
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif; /* Fonte padrão do sistema */
      background:var(--bg); /* Cor de fundo principal */
      color:var(--text); /* Cor padrão do texto */
    }

    .container { max-width:900px; margin:40px auto; padding:0 16px; } /* Container centralizado com largura máxima */

    .card { 
      background:var(--card); /* Cor de fundo do cartão */
      border-radius:16px; /* Cantos arredondados */
      padding:24px; /* Espaçamento interno */
      box-shadow:0 10px 30px rgba(0,0,0,.3); /* Sombra do cartão */
    }

    h1 { margin:0 0 8px; font-weight:700; } /* Estilo do título principal */

    p.sub { color:var(--muted); margin-top:0; } /* Texto auxiliar com cor mais clara */

    /* Área para upload de arquivos */
    .uploader { 
      border:2px dashed #334155; /* Borda pontilhada */
      border-radius:12px; /* Cantos arredondados */
      padding:20px; 
      text-align:center; /* Centraliza conteúdo */
    }

    /* Input de upload */
    input[type=file]{ width:100%; margin:8px 0; }

    /* Botões padrão */
    button{ 
      background:var(--accent); /* Cor de fundo */
      border:none; /* Sem borda */
      color:#052e16; /* Cor do texto */
      padding:12px 18px; /* Espaçamento interno */
      border-radius:10px; /* Cantos arredondados */
      font-weight:700; /* Texto em negrito */
      cursor:pointer; /* Cursor em formato de mão */
    }

    /* Botão desabilitado */
    button:disabled{ opacity:.6; cursor:not-allowed; }

    /* Texto de status */
    .status{ margin-top:16px; color:var(--muted); }

    /* Tabela de resultados */
    table{ width:100%; border-collapse:collapse; margin-top:16px; }

    /* Estilo das células */
    th,td{ padding:10px; border-bottom:1px solid #1f2937; font-size:14px; }

    /* Cabeçalho da tabela */
    th{ text-align:left; color:#cbd5e1; }

    /* Alinhamento à direita */
    .right{ text-align:right; }

    /* Layout em grid para responsividade */
    .grid{ display:grid; gap:16px; grid-template-columns:1fr; }

    /* Quando a tela for maior que 700px, divide em 2 colunas */
    @media(min-width:700px){ .grid{ grid-template-columns:2fr 1fr; } }

    /* Estilo para indicadores numéricos (KPIs) */
    .kpi{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }

    /* Caixa dos KPIs */
    .pill{ background:#0b1220; border-radius:10px; padding:10px 12px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <!-- Título e descrição -->
      <h1>CATEC - Extração de Nº de Protocolos</h1>
      <p class="sub">Envie imagens (.jpg, .png, .tif...) para reconhecer o número de protocolo. O Excel é acumulativo.</p>

      <div class="grid">
        <div>
          <!-- Área de upload -->
          <div class="uploader">
            <input id="files" type="file" accept="image/*,.tif,.tiff,.bmp,.webp,.jfif" multiple> <!-- Input para selecionar múltiplas imagens -->
            <button id="sendBtn">Processar</button> <!-- Botão para enviar os arquivos -->
            <div class="status" id="status">Pronto.</div> <!-- Status inicial -->
          </div>

          <!-- Caixa de resumo dos resultados -->
          <div id="resumoBox" class="card" style="background:#0b1220; display:none; margin-top:16px;">
            <h3 style="margin:0 0 8px;">Resumo do Lote</h3>
            <div class="kpi">
              <!-- Indicadores de processamento -->
              <span class="pill">Total: <b id="k_total">0</b></span>
              <span class="pill">Processados: <b id="k_proc">0</b></span>
              <span class="pill">Encontrados: <b id="k_ok">0</b></span>
              <span class="pill">Não encontrados: <b id="k_nok">0</b></span>
              <span class="pill">Tempo (s): <b id="k_time">0</b></span>
            </div>
          </div>

          <!-- Tabela que exibirá os resultados do processamento -->
          <table id="table" style="display:none">
            <thead>
              <tr>
                <th>#</th> <!-- Índice -->
                <th>Arquivo</th> <!-- Nome do arquivo -->
                <th>Protocolo (formatado)</th> <!-- Número reconhecido com formatação -->
                <th>17 dígitos</th> <!-- Número puro -->
                <th class="right">Data extração</th> <!-- Data e hora da extração -->
              </tr>
            </thead>
            <tbody></tbody> <!-- Corpo da tabela será preenchido via JavaScript -->
          </table>
        </div>

        <!-- Área lateral com informações sobre o Excel -->
        <div>
          <div class="card" style="background:#0b1220">
            <h3 style="margin-top:0">Planilha Excel</h3>
            <p class="sub">Baixe sempre a versão atualizada (consolidada).</p>
            <p><a id="excelLink" class="link" href="#" target="_blank" rel="noopener" style="color:#93c5fd;">Baixar Excel</a></p>
            <p class="sub" id="totais"></p> <!-- Texto que mostra total acumulado -->
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ---------- VARIÁVEIS E ELEMENTOS HTML ---------- */
const API = "http://127.0.0.1:8000"; // URL base da API backend
const filesEl = document.getElementById("files"); // Input de arquivos
const sendBtn = document.getElementById("sendBtn"); // Botão de envio
const statusEl = document.getElementById("status"); // Elemento de status
const table = document.getElementById("table"); // Tabela de resultados
const tbody = table.querySelector("tbody"); // Corpo da tabela
const excelLink = document.getElementById("excelLink"); // Link para download do Excel
const totals = document.getElementById("totais"); // Exibe total acumulado
const resumoBox = document.getElementById("resumoBox"); // Caixa do resumo
const kTotal = document.getElementById("k_total"); // Total de documentos
const kProc  = document.getElementById("k_proc"); // Total processados
const kOk    = document.getElementById("k_ok"); // Total encontrados
const kNok   = document.getElementById("k_nok"); // Total não encontrados
const kTime  = document.getElementById("k_time"); // Tempo total

excelLink.href = API + "/download/excel"; // Define o link inicial para o Excel

/* ---------- EVENTO DO BOTÃO PROCESSAR ---------- */
sendBtn.onclick = async () => {
  const files = filesEl.files; // Obtém arquivos selecionados
  if (!files || files.length === 0) { // Se não houver arquivos
    alert("Selecione ao menos uma imagem."); // Alerta ao usuário
    return;
  }

  sendBtn.disabled = true; // Desabilita botão enquanto processa
  statusEl.textContent = "Enviando e processando..."; // Atualiza status

  const form = new FormData(); // Cria formulário para envio
  for (const f of files) form.append("files", f, f.name); // Adiciona cada arquivo ao FormData

  try {
    // Envia arquivos para a API usando POST
    const res = await fetch(API + "/extract", { method: "POST", body: form });
    if (!res.ok) throw new Error("Falha no processamento"); // Se falhar, lança erro
    const data = await res.json(); // Converte resposta para JSON

    /* ---------- ATUALIZA RESUMO ---------- */
    if (data.resumo) {
      resumoBox.style.display = "block"; // Mostra caixa de resumo
      kTotal.textContent = data.resumo.total_docs ?? 0; // Total de documentos
      kProc.textContent  = data.resumo.processados ?? 0; // Processados
      kOk.textContent    = data.resumo.encontrados ?? 0; // Encontrados
      kNok.textContent   = data.resumo.nao_encontrados ?? 0; // Não encontrados
      kTime.textContent  = data.resumo.tempo_total_s ?? 0; // Tempo total em segundos
    }

    /* ---------- PREENCHIMENTO DA TABELA ---------- */
    tbody.innerHTML = ""; // Limpa tabela antes de preencher
    for (const r of data.resultados_lote) { // Itera sobre resultados
      const tr = document.createElement("tr"); // Cria nova linha
      tr.innerHTML = `
        <td>${r.indice_processamento ?? ""}</td>
        <td>${r.arquivo || ""}</td>
        <td>${r.protocolo_ocr || ""}</td>
        <td style="font-family:monospace">${r.protocolo_17_digitos || ""}</td>
        <td class="right">${r.data_extracao || ""}</td>
      `;
      tbody.appendChild(tr); // Adiciona linha à tabela
    }
    table.style.display = "table"; // Exibe tabela

    /* ---------- ATUALIZA LINK DO EXCEL ---------- */
    totals.textContent = "Total de protocolos (no Excel): " + (data.total_protocolos_no_excel ?? 0);
    excelLink.href = API + (data.excel_path || "/download/excel");

    statusEl.textContent = "Concluído!"; // Atualiza status final
  } catch (e) {
    console.error(e); // Mostra erro no console
    statusEl.textContent = "Erro: " + e.message; // Exibe erro na interface
  } finally {
    sendBtn.disabled = false; // Reabilita botão
  }
};
</script>
</body>
</html>
