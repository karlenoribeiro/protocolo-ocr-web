<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>Extração de Protocolos (17 dígitos)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <style>
    /* ---------- VARIÁVEIS DE CORES ---------- */
    :root { 
        --bg:#0f172a; 
        --card:#111827; 
        --text:#e5e7eb; 
        --muted:#9ca3af; 
        --accent:#22c55e; 
        --error:#ef4444; /* Nova cor para erros/duplicados */
    }

    /* ---------- ESTILIZAÇÃO GERAL (Responsiva) ---------- */
    body { 
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif;
      background:var(--bg);
      color:var(--text);
      display: flex; 
      flex-direction: column; 
      min-height: 100vh; /* Permite o rodapé ficar no fundo */
    }

    .container { 
      max-width:900px; 
      margin:40px auto; 
      padding:0 16px; 
      flex-grow: 1; /* Permite o container crescer */
    }

    .card { 
      background:var(--card); 
      border-radius:16px; 
      padding:24px; 
      box-shadow:0 10px 30px rgba(0,0,0,.3); 
    }

    h1 { margin:0 0 8px; font-weight:700; }
    p.sub { color:var(--muted); margin-top:0; }

    /* Área para upload de arquivos */
    .uploader { 
      border:2px dashed #334155; 
      border-radius:12px; 
      padding:20px; 
      text-align:center;
      display: flex; /* Usando flexbox */
      flex-direction: column;
      gap: 10px;
    }

    /* Input de upload */
    input[type=file]{ padding:10px; background:var(--bg); color:var(--text); border-radius:8px; border: 1px solid #334155; }

    /* Botões padrão */
    button{ 
      background:var(--accent);
      border:none;
      color:#052e16;
      padding:12px 18px;
      border-radius:10px;
      font-weight:700;
      cursor:pointer;
      transition:background 0.2s; 
    }
    button:hover{ background:#10b981; }
    button:disabled{ opacity:.6; cursor:not-allowed; }

    /* Texto de status */
    .status{ margin-top:16px; color:var(--muted); }

    /* Layout em grid para responsividade */
    .grid{ display:flex; flex-direction:column; gap:20px; } /* Mobile: Coluna */
    
    /* Quando a tela for maior que 700px, divide em 2 colunas */
    @media(min-width:700px){ 
      .grid{ flex-direction:row; } /* Desktop: Linha */
      .grid > div:first-child { flex: 2; } /* Coluna principal 2/3 */
      .grid > div:last-child { flex: 1; } /* Coluna lateral 1/3 */
    }

    /* Estilo para indicadores numéricos (KPIs) */
    .kpi{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; font-size:0.9em; }

    /* Caixa dos KPIs */
    .pill{ background:var(--bg); border-radius:6px; padding:8px 10px; white-space:nowrap; }

    /* Tabela de resultados */
    table{ width:100%; border-collapse:collapse; margin-top:20px; }
    th,td{ padding:10px; border-bottom:1px solid #1f2937; font-size:14px; }
    th{ text-align:left; color:#cbd5e1; }
    .right{ text-align:right; }
    
    /* Linha Duplicada (destaque) */
    .duplicate-row td { 
        background-color: #440000 !important; 
        color: var(--error) !important; 
        opacity:0.8; 
    }

    /* Lista de duplicados ignorados */
    .duplicates-list-box {
        margin-top: 16px;
        padding: 10px;
        background: #0b1220;
        border: 1px solid var(--error);
        border-radius: 8px;
    }
    .duplicates-list-content {
        font-family: monospace;
        font-size: 12px;
        color: var(--error);
        word-break: break-all;
        margin-top: 5px;
    }
    
    /* Rodapé */
    footer {
        background: var(--card);
        color: var(--muted);
        text-align: center;
        padding: 10px 0;
        margin-top: 20px; /* Espaço entre o container e o rodapé */
        font-size: 12px;
        width: 100%;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>CATEC - Extração de Nº de Protocolos</h1>
      <p class="sub">Envie imagens (.jpg, .png, .tif...) para reconhecer o número de protocolo. Protocolos duplicados (no lote ou no histórico) **serão ignorados**.</p>

      <div class="grid">
        <div>
          <div class="uploader">
            <input id="files" type="file" accept="image/*,.tif,.tiff,.bmp,.webp,.jfif" multiple>
            <button id="sendBtn">Processar Arquivos</button>
            <div class="status" id="status">Pronto.</div>
          </div>

          <div id="resumoBox" class="card" style="background:#0b1220; display:none; margin-top:16px; padding: 15px;">
            <h3 style="margin:0 0 8px;">Resumo do Lote</h3>
            <div class="kpi">
              <span class="pill">Total Docs: <b id="k_total">0</b></span>
              <span class="pill">Protocolos Encontrados: <b id="k_ok">0</b></span>
              <span class="pill" style="border: 1px solid var(--accent);">Novos Adicionados: <b id="k_new" style="color:var(--accent)">0</b></span>
              <span class="pill" style="background:#440000; border: 1px solid var(--error); color:var(--error);">Duplicados Ignorados: <b id="k_dup_ignore">0</b></span>
              <span class="pill">Tempo (s): <b id="k_time">0</b></span>
            </div>
            <div id="duplicatesList" style="display:none">
                <p style="margin-top:16px; margin-bottom: 4px; color:var(--error); font-weight: bold;">Duplicados Ignorados:</p>
                <div class="duplicates-list-box">
                    <div class="duplicates-list-content" id="dup_list_content"></div>
                </div>
            </div>
          </div>

          <table id="table" style="display:none">
            <thead>
              <tr>
                <th>#</th>
                <th>Arquivo</th>
                <th>Protocolo (formatado)</th>
                <th>17 dígitos</th>
                <th class="right">Data extração</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div>
          <div class="card" style="background:#0b1220; padding: 15px;">
            <h3 style="margin-top:0">Planilha Consolidada</h3>
            <p class="sub">Baixe a versão atualizada contendo todos os protocolos válidos (sem duplicatas).</p>
            <p><a id="excelLink" class="link" href="#" target="_blank" rel="noopener" style="color:#93c5fd; font-weight: bold;">Baixar Excel</a></p>
            <p class="sub" id="totais"></p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer id="footer"></footer>

<script>
/* ---------- VARIÁVEIS E ELEMENTOS HTML ---------- */
const API = "http://127.0.0.1:8000"; 
// REQUISITO: Versão configurável (v 1.0.0.0)
const APP_VERSION = "v 1.0.0.0"; 

const filesEl = document.getElementById("files"); 
const sendBtn = document.getElementById("sendBtn"); 
const statusEl = document.getElementById("status"); 
const table = document.getElementById("table"); 
const tbody = table.querySelector("tbody"); 
const excelLink = document.getElementById("excelLink"); 
const totals = document.getElementById("totais"); 
const resumoBox = document.getElementById("resumoBox"); 

// Novos elementos para o Resumo
const kTotal = document.getElementById("k_total"); 
const kOk = document.getElementById("k_ok");
const kNew = document.getElementById("k_new"); 
const kDupIgnore = document.getElementById("k_dup_ignore"); 
const kTime = document.getElementById("k_time");
const duplicatesList = document.getElementById("duplicatesList");
const dupListContent = document.getElementById("dup_list_content");
const footer = document.getElementById("footer");

excelLink.href = API + "/download/excel"; 
footer.textContent = `v ${APP_VERSION} - Protocolo OCR Web`; // Adiciona versão no rodapé

/* ---------- EVENTO DO BOTÃO PROCESSAR ---------- */
sendBtn.onclick = async () => {
  const files = filesEl.files; 
  if (!files || files.length === 0) { 
    alert("Selecione ao menos uma imagem."); 
    return;
  }

  sendBtn.disabled = true; 
  statusEl.textContent = `Enviando ${files.length} arquivo(s) e processando... Aguarde.`;

  const form = new FormData(); 
  for (const f of files) form.append("files", f, f.name); 

  try {
    const res = await fetch(API + "/extract", { method: "POST", body: form });
    if (!res.ok) throw new Error(`Falha no processamento: HTTP ${res.status}`); 
    const data = await res.json(); 

    /* ---------- ATUALIZA RESUMO ---------- */
    const resumo = data.resumo;
    if (resumo) {
      resumoBox.style.display = "block"; 
      kTotal.textContent = resumo.total_docs ?? 0;
      kOk.textContent    = resumo.encontrados_lote ?? 0; 
      kNew.textContent   = resumo.novos_adicionados ?? 0; 
      kDupIgnore.textContent = resumo.duplicados_ignorar ?? 0; 
      kTime.textContent  = resumo.tempo_total_s ?? 0;

      // Exibe lista de duplicados ignorados
      if (resumo.duplicados_lista && resumo.duplicados_lista.length > 0) {
          duplicatesList.style.display = "block";
          dupListContent.textContent = resumo.duplicados_lista.join(", ");
      } else {
          duplicatesList.style.display = "none";
          dupListContent.textContent = "Nenhum protocolo duplicado ignorado neste lote.";
      }
      
      // Mensagem de status detalhada (REQUISITO)
      statusEl.textContent = `Processamento concluído: ${resumo.processados} imagens processadas — ${resumo.encontrados_lote} protocolos encontrados — ${resumo.novos_adicionados} novos adicionados — ${resumo.duplicados_ignorar} duplicados ignorados. Duplicados: [${resumo.duplicados_lista.join(', ')}]`;
    }

    /* ---------- PREENCHIMENTO DA TABELA ---------- */
    tbody.innerHTML = ""; 
    for (const r of data.resultados_lote) { 
      const tr = document.createElement("tr"); 
      // Classe para duplicados ignorados (destaque visual)
      if (r.duplicado) {
          tr.classList.add('duplicate-row');
          tr.title = "Protocolo Duplicado - Ignorado no Excel";
      }
      
      tr.innerHTML = `
        <td>${r.indice_processamento ?? ""}</td>
        <td>${r.arquivo || ""}</td>
        <td>${r.protocolo_ocr || ""}</td>
        <td style="font-family:monospace">${r.protocolo_17_digitos || ""}</td>
        <td class="right">${r.data_extracao || ""}</td>
      `;
      tbody.appendChild(tr); 
    }
    table.style.display = "table"; 

    /* ---------- ATUALIZA LINK DO EXCEL ---------- */
    totals.textContent = "Total de protocolos (no Excel): " + (data.total_protocolos_no_excel ?? 0);
    excelLink.href = API + (data.excel_path || "/download/excel");

  } catch (e) {
    console.error(e); 
    statusEl.textContent = "Erro: " + e.message; 
  } finally {
    sendBtn.disabled = false; 
  }
};
</script>
</body>
</html>